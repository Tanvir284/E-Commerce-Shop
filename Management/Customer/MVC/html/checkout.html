<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | E-Shop Bangladesh</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/shop.css">
    <link rel="stylesheet" href="../css/checkout.css">
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <a href="index.html" class="logo">
                <div class="logo-icon">üõçÔ∏è</div>
                <span>E-Shop</span>
            </a>
            <div style="flex:1; text-align:center; font-weight:600; color:var(--gray-600);">
                üîí Secure Checkout
            </div>
            <nav class="nav-links">
                <a href="cart.html" class="nav-link">‚Üê Back to Cart</a>
            </nav>
        </div>
    </header>

    <!-- Checkout -->
    <main class="checkout-page">
        <h1>üì¶ Checkout</h1>

        <form id="checkoutForm" class="checkout-layout">
            <div>
                <!-- Shipping -->
                <div class="checkout-section">
                    <h2>üìç Delivery Address</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Full Name *</label>
                            <input type="text" name="fullName" required placeholder="Your name">
                        </div>
                        <div class="form-group">
                            <label>Phone *</label>
                            <input type="tel" name="phone" required placeholder="01XXXXXXXXX">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" name="email" required placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>Address *</label>
                        <input type="text" name="address" required placeholder="House, Road, Area">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>City *</label>
                            <select name="city" required>
                                <option value="">Select</option>
                                <option>Dhaka</option>
                                <option>Chittagong</option>
                                <option>Sylhet</option>
                                <option>Rajshahi</option>
                                <option>Khulna</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ZIP</label>
                            <input type="text" name="zip" placeholder="1000">
                        </div>
                    </div>
                </div>

                <!-- Payment -->
                <div class="checkout-section">
                    <h2>üí≥ Payment Method</h2>
                    <div class="payment-options">
                        <label class="payment-option">
                            <input type="radio" name="payment" value="Cash on Delivery" checked>
                            <span class="payment-label">
                                <span class="payment-icon">üíµ</span>
                                <div class="payment-info">
                                    <h4>Cash on Delivery</h4>
                                    <p>Pay when you receive</p>
                                </div>
                            </span>
                        </label>
                        <label class="payment-option">
                            <input type="radio" name="payment" value="bKash">
                            <span class="payment-label">
                                <span class="payment-icon">üì±</span>
                                <div class="payment-info">
                                    <h4>bKash</h4>
                                    <p>Mobile banking</p>
                                </div>
                            </span>
                        </label>
                        <label class="payment-option">
                            <input type="radio" name="payment" value="Card">
                            <span class="payment-label">
                                <span class="payment-icon">üí≥</span>
                                <div class="payment-info">
                                    <h4>Card Payment</h4>
                                    <p>Visa, MasterCard</p>
                                </div>
                            </span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Summary -->
            <div class="checkout-summary">
                <h2>üßæ Order Summary</h2>
                <div class="order-items" id="orderItems">Loading...</div>
                <div class="summary-row">
                    <span>Subtotal</span>
                    <span id="subtotal">‡ß≥0</span>
                </div>
                <div class="summary-row">
                    <span>Shipping</span>
                    <span style="color:var(--accent)">Free</span>
                </div>
                <div class="summary-row total">
                    <span>Total</span>
                    <span id="total">‡ß≥0</span>
                </div>
                <button type="submit" class="place-order-btn" id="placeOrderBtn">
                    Place Order ‚Üí
                </button>
                <p class="secure-note">üîê Your payment is secure</p>
            </div>
        </form>
    </main>

    <!-- Success Modal -->
    <div id="successModal" class="modal">
        <div class="success-modal">
            <div class="success-icon">‚úì</div>
            <h2>Order Placed!</h2>
            <p>Thank you for your order</p>
            <div class="order-number">Order <span id="orderId">#0</span></div>
            <div class="modal-actions">
                <a href="orders.html" class="btn-primary">View Orders</a>
                <a href="index.html" class="btn-secondary">Continue</a>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadSummary();
            document.getElementById('checkoutForm').addEventListener('submit', placeOrder);
        });

        function loadSummary() {
            fetch('../php/cartApi.php?action=get')
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        if (!data.items.length) { window.location.href = 'cart.html'; return; }
                        renderSummary(data.items, data.total);
                    } else if (data.redirect) window.location.href = data.redirect;
                });
        }

        function renderSummary(items, total) {
            document.getElementById('subtotal').textContent = '‡ß≥' + parseFloat(total).toLocaleString();
            document.getElementById('total').textContent = '‡ß≥' + parseFloat(total).toLocaleString();
            document.getElementById('orderItems').innerHTML = items.map(i => `
                <div class="order-item">
                    <img src="../../../Admin/MVC/images/${i.image}" onerror="this.src='https://via.placeholder.com/50'">
                    <div class="order-item-info">
                        <h4>${i.name}</h4>
                        <span>Qty: ${i.quantity}</span>
                    </div>
                    <div class="order-item-price">‡ß≥${parseFloat(i.subtotal).toLocaleString()}</div>
                </div>
            `).join('');
        }

        function placeOrder(e) {
            e.preventDefault();
            const btn = document.getElementById('placeOrderBtn');
            btn.disabled = true; btn.textContent = 'Processing...';

            const formData = new FormData(e.target);
            formData.append('shipping_address', [formData.get('address'), formData.get('city'), formData.get('zip')].filter(Boolean).join(', '));

            fetch('../php/checkoutApi.php?action=place', { method: 'POST', body: formData })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('orderId').textContent = '#' + data.order_id;
                        document.getElementById('successModal').style.display = 'block';
                    } else {
                        showToast(data.message, 'error');
                        btn.disabled = false; btn.textContent = 'Place Order ‚Üí';
                    }
                });
        }

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.className = 'toast ' + type + ' show';
            setTimeout(() => t.classList.remove('show'), 3000);
        }
    </script>
</body>

</html>